![Source](https://youtu.be/mPaCnwpFvZY)

### Installation
```bash
pnpm add @tanstack/react-query
pnpm add -D @tanstack/eslint-plugin-query
```

### Setup
1. Wrap the entire app with the QueryClientProvider
```ts
import "@/styles/globals.css";  
  
import { type Metadata } from "next";  
import { Geist } from "next/font/google";  
import TanstackProvider from "@/components/providers/tanstack-provider";  
  
export const metadata: Metadata = {  
  title: "Create T3 App",  
  description: "Generated by create-t3-app",  
  icons: [{ rel: "icon", url: "/favicon.ico" }],  
};  
  
const geist = Geist({  
  subsets: ["latin"],  
  variable: "--font-geist-sans",  
});  
  
  
export default function RootLayout({  
  children,  
}: Readonly<{ children: React.ReactNode }>) {  
  return (  
    <TanstackProvider>  
      <html lang="en" className={`${geist.variable}`}>  
        <body>{children}</body>  
      </html>  
    </TanstackProvider>  
  );  
}
```
**Note** : Here the ==TanstackProvider== is a custom provider because the QueryClientProvider has to be a client component to get executed, but the layout file needs to be a server component.

2. The custom provider
```ts
"use client";  
  
import React from "react";  
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";  
  
const queryClient = new QueryClient();  
  
export default function TanstackProvider({children}:{children:React.ReactNode}) {  
  return (  
    <QueryClientProvider client={queryClient}>  
      {children}  
    </QueryClientProvider>  
  );  
}
```

### Using tanstack/react query
1. Fetching data
```ts
"use client";  
  
import type { TodoType } from "@/types/todoType";  
import { useQuery } from "@tanstack/react-query";  
  
const Page = () => {  
    
  const {data: todos,isPending} = useQuery({  
    queryKey:["todo"],  
    queryFn: async () => {  
      const res = await fetch("/api/todo/");  
      const res_data = (await res.json()) as TodoType[];  
      return res_data;  
    }  
  });  
  
  return (  
    <div>  
      Todo List  
      {isPending ? <p>Loading...</p> : <div className={"flex flex-col gap-2"}>  
        {todos?.length !== 0 ? <div>  
          {  
            todos?.map((todo:TodoType) => (  
              <p key={todo.id}>{todo.name}</p>  
            ))  
          }  
        </div> : <p>No Todos</p>}  
      </div>}  
    </div>  
  );  
};  
  
export default Page;
```

**Note** : 
- **Do not call `setState` in `queryFn`**  
    Let TanStack Query handle the state (`data`, `isLoading`, `isError`, etc.).
    
- **Always return the data** from `queryFn`.  
    This data is cached internally and used in `data`

==The following are the different functions and attributes returned by the useQuery==
```ts
const {
  data,
  dataUpdatedAt,
  error,
  errorUpdatedAt,
  failureCount,
  failureReason,
  fetchStatus,
  isError,
  isFetched,
  isFetchedAfterMount,
  isFetching,
  isInitialLoading,
  isLoading,
  isLoadingError,
  isPaused,
  isPending,
  isPlaceholderData,
  isRefetchError,
  isRefetching,
  isStale,
  isSuccess,
  isEnabled,
  promise,
  refetch,
  status,
} = useQuery(
  {
    queryKey,
    queryFn,
    gcTime,
    enabled,
    networkMode,
    initialData,
    initialDataUpdatedAt,
    meta,
    notifyOnChangeProps,
    placeholderData,
    queryKeyHashFn,
    refetchInterval,
    refetchIntervalInBackground,
    refetchOnMount,
    refetchOnReconnect,
    refetchOnWindowFocus,
    retry,
    retryOnMount,
    retryDelay,
    select,
    staleTime,
    structuralSharing,
    subscribed,
    throwOnError,
  },
  queryClient,
)
```

### Full Implementation Example
```tsx
"use client";  
  
import { useState } from "react";  
import type { TodoType } from "@/types/todoType";  
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";  
import { Trash2, Plus, Check, X } from "lucide-react";  
  
const Page = () => {  
  const [newTodoName, setNewTodoName] = useState("");  
  const [editingId, setEditingId] = useState<string | null>(null);  
  const [editingName, setEditingName] = useState("");  
  const queryClient = useQueryClient();  
  
  const { data: todos, isLoading, isError } = useQuery<TodoType[]>({  
    queryKey: ["todo"],  
    queryFn: async () => {  
      const res = await fetch("/api/todo/");  
      if (!res.ok) throw new Error("Failed to fetch todos");  
      return (await res.json()) as TodoType[];  
    },  
  });  
  
  const createMutation = useMutation({  
    mutationFn: async (name: string) => {  
      const res = await fetch("/api/todo/", {  
        method: "POST",  
        headers: { "Content-Type": "application/json" },  
        body: JSON.stringify({ name }),  
      });  
      if (!res.ok) throw new Error("Failed to create todo");  
      return await res.json();  
    },  
    onSuccess: async () => {  
      await queryClient.invalidateQueries({ queryKey: ["todo"] });  
      setNewTodoName("");  
    },  
  });  
  
  const updateMutation = useMutation({  
    mutationFn: async ({ id, data }: { id: string; data: { name?: string; done?: boolean } }) => {  
      const res = await fetch("/api/todo/", {  
        method: "PATCH",  
        headers: { "Content-Type": "application/json" },  
        body: JSON.stringify({ id, ...data }),  
      });  
      if (!res.ok) throw new Error("Failed to update todo");  
      return await res.json();  
    },  
    onSuccess: async () => {  
      await queryClient.invalidateQueries({ queryKey: ["todo"] });  
      setEditingId(null);  
      setEditingName("");  
    },  
  });  
  
  const deleteMutation = useMutation({  
    mutationFn: async (id: string) => {  
      const res = await fetch("/api/todo/", {  
        method: "DELETE",  
        headers: { "Content-Type": "application/json" },  
        body: JSON.stringify({ id }),  
      });  
      if (!res.ok) throw new Error("Failed to delete todo");  
      return await res.json();  
    },  
    onSuccess: async () => {  
      await queryClient.invalidateQueries({ queryKey: ["todo"] });  
    },  
  });  
  
  const handleCreate = (e: React.FormEvent) => {  
    e.preventDefault();  
    if (newTodoName.trim()) {  
      createMutation.mutate(newTodoName.trim());  
    }  
  };  
  
  const handleToggleDone = (todo: TodoType) => {  
    updateMutation.mutate({ id: todo.id, data: { done: !todo.done } });  
  };  
  
  const handleStartEdit = (todo: TodoType) => {  
    setEditingId(todo.id);  
    setEditingName(todo.name);  
  };  
  
  const handleSaveEdit = (id: string) => {  
    if (editingName.trim()) {  
      updateMutation.mutate({ id, data: { name: editingName.trim() } });  
    }  
  };  
  
  const handleCancelEdit = () => {  
    setEditingId(null);  
    setEditingName("");  
  };  
  
  const handleDelete = (id: string) => {  
    if (confirm("Are you sure you want to delete this todo?")) {  
      deleteMutation.mutate(id);  
    }  
  };  
  
  if (isLoading) {  
    return (  
      <div className="flex justify-center items-center min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50">  
        <div className="text-center">  
          <div className="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>  
          <p className="text-gray-600 text-lg font-medium">Loading your todos...</p>  
        </div>  
      </div>  
    );  
  }  
  
  if (isError) {  
    return (  
      <div className="flex justify-center items-center min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50">  
        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md">  
          <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">  
            <X className="w-8 h-8 text-red-500" />  
          </div>  
          <p className="text-red-600 text-lg font-semibold text-center">Failed to load todos</p>  
          <p className="text-gray-500 text-sm text-center mt-2">Please try refreshing the page</p>  
        </div>  
      </div>  
    );  
  }  
  
  const pendingTodos = todos?.filter(t => !t.done) || [];  
  const completedTodos = todos?.filter(t => t.done) || [];  
  
  return (  
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 py-12 px-4">  
      <div className="max-w-3xl mx-auto">  
        {/* Header */}  
        <div className="text-center mb-8">  
          <h1 className="text-5xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">  
            Todo List  
          </h1>  
          <p className="text-gray-600">Stay organized and get things done</p>  
        </div>  
  
        {/* Create Todo Form */}  
        <form onSubmit={handleCreate} className="mb-8">  
          <div className="bg-white rounded-2xl shadow-lg p-6">  
            <div className="flex gap-3">  
              <input  
                type="text"  
                value={newTodoName}  
                onChange={(e) => setNewTodoName(e.target.value)}  
                placeholder="What needs to be done?"  
                className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-purple-500 transition-colors text-gray-800"  
                disabled={createMutation.isPending}  
              />  
              <button  
                type="submit"  
                disabled={createMutation.isPending || !newTodoName.trim()}  
                className="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2 shadow-lg hover:shadow-xl"  
              >  
                <Plus className="w-5 h-5" />  
                Add  
              </button>  
            </div>  
          </div>  
        </form>  
  
        {/* Pending Todos */}  
        {pendingTodos.length > 0 && (  
          <div className="mb-8">  
            <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">  
              <div className="w-2 h-2 bg-yellow-500 rounded-full"></div>  
              Pending ({pendingTodos.length})  
            </h2>  
            <div className="space-y-3">  
              {pendingTodos.map((todo) => (  
                <div  
                  key={todo.id}  
                  className="bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow p-4"  
                >  
                  <div className="flex items-center gap-3">  
                    <button  
                      onClick={() => handleToggleDone(todo)}  
                      disabled={updateMutation.isPending}  
                      className="w-6 h-6 border-2 border-gray-300 rounded-full hover:border-green-500 hover:bg-green-50 transition-all flex-shrink-0"  
                    ></button>  
  
                    {editingId === todo.id ? (  
                      <div className="flex-1 flex gap-2">  
                        <input  
                          type="text"  
                          value={editingName}  
                          onChange={(e) => setEditingName(e.target.value)}  
                          className="flex-1 px-3 py-1 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-purple-500 text-gray-800"  
                          autoFocus  
                        />  
                        <button  
                          onClick={() => handleSaveEdit(todo.id)}  
                          className="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"  
                        >  
                          <Check className="w-4 h-4" />  
                        </button>  
                        <button  
                          onClick={handleCancelEdit}  
                          className="p-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"  
                        >  
                          <X className="w-4 h-4" />  
                        </button>  
                      </div>  
                    ) : (  
                      <>  
                        <p  
                          onClick={() => handleStartEdit(todo)}  
                          className="flex-1 text-gray-800 font-medium cursor-pointer hover:text-purple-600 transition-colors"  
                        >  
                          {todo.name}  
                        </p>  
                        <button  
                          onClick={() => handleDelete(todo.id)}  
                          disabled={deleteMutation.isPending}  
                          className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all"  
                        >  
                          <Trash2 className="w-5 h-5" />  
                        </button>  
                      </>  
                    )}  
                  </div>  
                </div>  
              ))}  
            </div>  
          </div>  
        )}  
  
        {/* Completed Todos */}  
        {completedTodos.length > 0 && (  
          <div>  
            <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">  
              <div className="w-2 h-2 bg-green-500 rounded-full"></div>  
              Completed ({completedTodos.length})  
            </h2>  
            <div className="space-y-3">  
              {completedTodos.map((todo) => (  
                <div  
                  key={todo.id}  
                  className="bg-white/60 rounded-xl shadow-md p-4 opacity-75"  
                >  
                  <div className="flex items-center gap-3">  
                    <button  
                      onClick={() => handleToggleDone(todo)}  
                      disabled={updateMutation.isPending}  
                      className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0 hover:bg-green-600 transition-colors"  
                    >  
                      <Check className="w-4 h-4 text-white" />  
                    </button>  
  
                    <p className="flex-1 text-gray-500 line-through font-medium">  
                      {todo.name}  
                    </p>  
  
                    <button  
                      onClick={() => handleDelete(todo.id)}  
                      disabled={deleteMutation.isPending}  
                      className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all"  
                    >  
                      <Trash2 className="w-5 h-5" />  
                    </button>  
                  </div>  
                </div>  
              ))}  
            </div>  
          </div>  
        )}  
  
        {/* Empty State */}  
        {todos && todos.length === 0 && (  
          <div className="bg-white rounded-2xl shadow-lg p-12 text-center">  
            <div className="w-20 h-20 bg-gradient-to-br from-purple-100 to-pink-100 rounded-full flex items-center justify-center mx-auto mb-4">  
              <Check className="w-10 h-10 text-purple-500" />  
            </div>  
            <h3 className="text-xl font-bold text-gray-800 mb-2">No todos yet</h3>  
            <p className="text-gray-500">Add your first todo to get started!</p>  
          </div>  
        )}  
      </div>  
    </div>  
  );  
};  
  
export default Page;
```
